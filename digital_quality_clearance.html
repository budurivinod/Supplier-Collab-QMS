<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Quality Clearance</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #005A9C;
            --secondary-color: #003B65;
            --accent-color: #FDB813;
            --light-gray: #f4f4f4;
            --medium-gray: #ccc;
            --dark-gray: #555;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --pending-color: #ffc107;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 95%;
            max-width: 1400px;
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        /* --- Login Screen --- */
        #login-screen {
            padding: 40px;
            max-width: 400px;
            margin: 40px auto;
            text-align: center;
        }

        #login-screen h1 {
            color: var(--primary-color);
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            box-sizing: border-box;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
            width: 100%;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        #login-error {
            color: var(--danger-color);
            margin-top: 15px;
        }

        /* --- Main App --- */
        #app-screen {
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: var(--primary-color);
            color: #fff;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 24px;
        }

        #user-info {
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        #user-info span {
            font-weight: bold;
        }

        #profile-btn, #logout-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.7);
            color: #fff;
            margin-left: 10px;
            padding: 6px 14px;
            font-size: 14px;
            font-weight: normal;
        }
        #profile-btn:hover, #logout-btn:hover {
            background-color: #fff;
            color: var(--primary-color);
        }
        #profile-btn svg, #logout-btn svg {
            width: 16px;
            height: 16px;
            stroke-width: 2.5;
        }

        main {
            padding: 30px;
            flex-grow: 1;
        }

        /* --- Notification Bar --- */
        #notification-bar {
            background-color: var(--accent-color);
            color: var(--secondary-color);
            padding: 15px;
            text-align: center;
            font-weight: bold;
            display: none; /* Hidden by default */
            transition: opacity 0.5s ease;
        }

        .notification-success {
            background-color: var(--success-color);
            color: white;
        }

        .notification-danger {
            background-color: var(--danger-color);
            color: white;
        }

        /* --- Dashboard View --- */
        #dashboard-view h2 {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--light-gray);
            padding-bottom: 10px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .search-container {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        #product-search-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 16px;
        }

        /* --- Dashboard Tabs --- */
        .dashboard-tabs {
            margin-top: 20px;
            border-bottom: 2px solid var(--medium-gray);
        }
        .tab-link {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        .tab-link.active {
            border-bottom-color: var(--primary-color);
            font-weight: bold;
            color: var(--primary-color);
        }
        .tab-content {
            display: none;
            padding-top: 20px;
        }
        .tab-content.active {
            display: block;
        }
        .tab-count {
            background-color: var(--medium-gray);
            color: #fff;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 8px;
            font-weight: normal;
            vertical-align: middle;
            transition: background-color 0.2s;
        }
        .tab-link.active .tab-count {
            background-color: var(--primary-color);
        }

        /* --- Analysis Tab Grid --- */
        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        .image-upload-box {
            border: 2px dashed var(--medium-gray);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background-color: #fcfcfc;
            transition: background-color 0.2s, border-color 0.2s;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .image-upload-box:hover {
            background-color: #e9f2fa;
            border-color: var(--primary-color);
        }
        .image-upload-box svg {
            width: 24px;
            height: 24px;
            stroke-width: 1.5;
            color: var(--medium-gray);
            transition: color 0.2s;
        }
        .image-upload-box:hover svg {
            color: var(--primary-color);
        }
        .image-upload-box p {
            margin: 0;
            font-weight: bold;
            color: var(--dark-gray);
        }
        .image-upload-box span {
            font-size: 14px;
            color: #888;
        }
        #image-file-input {
            display: none; /* Hide the default input */
        }

        /* --- Analytics View --- */
        #analytics-view h2 {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--light-gray);
            padding-bottom: 10px;
        }
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .product-table th, .product-table td {
            padding: 12px;
            border: 1px solid var(--medium-gray);
            text-align: left;
        }

        .product-table th {
            background-color: var(--light-gray);
            font-weight: bold;
        }

        .product-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .product-table tbody tr:hover {
            background-color: #e9f2fa;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-Approved { background-color: var(--success-color); }
        .status-Rejected { background-color: var(--danger-color); }
        .status-Pending { background-color: var(--pending-color); color: var(--dark-gray); }
        .status-Delivered { background-color: var(--primary-color); }

        /* --- Details View --- */
        #details-view {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }
        #main-details-col {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-icon svg {
            width: 18px;
            height: 18px;
        }

        .details-main-header {
            padding: 20px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: var(--border-radius);
        }
        .details-main-header h3 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        /* New Tab Styles */
        .details-tabs-container {
            margin-top: 10px;
        }
        .details-tabs {
            border-bottom: 2px solid var(--medium-gray);
            display: flex;
        }
        .details-tab-link {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            color: var(--dark-gray);
        }
        .details-tab-link.active {
            border-bottom-color: var(--primary-color);
            font-weight: bold;
            color: var(--primary-color);
        }
        .details-tab-content { display: none; }
        .details-tab-content.active { display: block; padding-top: 20px; }

        .details-card {
            background-color: #fff;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .details-card h3 {
            color: var(--secondary-color);
            margin-top: 0;
            border-bottom: 2px solid var(--light-gray);
            padding-bottom: 10px;
        }
        .details-card h3 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .details-card h3 svg {
            width: 24px; height: 24px; stroke-width: 2; color: var(--primary-color);
        }

        #back-to-dashboard {
            margin-bottom: 20px;
            background-color: var(--dark-gray);
            color: #fff;
        }

        #back-to-dashboard-from-analytics {
            margin-bottom: 20px;
            background-color: var(--dark-gray);
            color: #fff;
        }
        #product-info p, #document-links p, #image-upload p, #approval-workflow p {
            margin: 10px 0;
        }

        #document-links a {
            color: var(--primary-color);
            text-decoration: none;
        }
        #document-links a:hover {
            text-decoration: underline;
        }

        #checklist ul {
            list-style-type: none;
            padding: 0;
        }

        #checklist li {
            padding: 8px;
            border-bottom: 1px solid var(--light-gray);
        }

        #checklist ul li {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checklist-text {
            flex-grow: 1;
            padding: 5px;
            border: 1px solid transparent;
            border-radius: 4px;
        }

        .checklist-text:focus {
            background-color: #e9f2fa;
            border-color: var(--primary-color);
            outline: none;
        }

        .delete-item-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            padding: 0 5px;
            line-height: 1;
            opacity: 0.4;
            transition: opacity 0.2s;
        }

        #checklist ul li:hover .delete-item-btn {
            opacity: 1;
        }

        #add-checklist-item-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        #checklist input[type="checkbox"] {
            margin-right: 10px;
        }

        #image-preview {
            max-width: 100%;
            margin-top: 15px;
            border-radius: var(--border-radius);
            display: none;
        }

        #comments {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            box-sizing: border-box;
            margin-top: 10px;
        }

        #generate-comments-btn {
            background-color: var(--accent-color);
            color: var(--secondary-color);
            margin-top: 10px;
            width: 100%;
            border: none;
        }

        #document-list a {
            color: var(--primary-color);
            text-decoration: none;
        }
        #document-list a:hover {
            text-decoration: underline;
        }

        #approval-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .btn-success { background-color: var(--success-color); color: #fff; }
        .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: var(--danger-color); color: #fff; }
        .btn-danger:hover { background-color: #c82333; }

        #audit-trail-list {
            list-style-type: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }

        #audit-trail-list li {
            padding: 10px;
            border-bottom: 1px solid var(--light-gray);
            font-size: 14px;
        }

        #audit-trail-list li:last-child {
            border-bottom: none;
        }

        .audit-timestamp {
            font-weight: bold;
            color: var(--primary-color);
        }

        .document-upload-area {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--light-gray);
        }
        .document-upload-area h4 {
            margin-top: 0;
            color: var(--secondary-color);
        }

        /* --- Utility Classes --- */
        .hidden {
            display: none !important;
        }
        .quality-only, .technical-only, .commercial-only {
            display: none;
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* --- Modal Styles --- */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Login Screen -->
        <div id="login-screen">
            <h1>Digital Quality Clearance</h1>
            <p>Please log in to continue.</p>
            <form id="dqc-login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <select id="username" required>
                        <option value="">Select User</option>
                        <option value="quality_user">quality_user (Quality)</option>
                        <option value="tech_user">tech_user (Technical)</option>
                        <option value="comm_user">comm_user (Commercial)</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
                <p id="dqc-login-error" class="hidden">Invalid credentials.</p>
            </form>
        </div>

        <!-- Main Application Screen -->
        <div id="app-screen" class="hidden">
            <header>
                <h1>DQC Portal</h1>
                <div id="user-info">
                    Welcome, <span id="user-display-name"></span> (<span id="user-role"></span>)
                    <button id="profile-btn" class="btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        Profile
                    </button>
                    <button id="logout-btn" class="btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        Logout
                    </button>
                </div>
            </header>

            <div id="notification-bar"></div>

            <main>
                <!-- Dashboard View -->
                <div id="dashboard-view">
                    <div class="dashboard-header">
                        <h2>Product Clearance Dashboard</h2>
                        <button id="view-analytics-btn" class="btn">View Analytics</button>
                    </div>
                    <div class="search-container">
                        <input type="text" id="product-search-input" placeholder="Filter by ID, Name, or PO Number...">
                        <button id="product-search-btn" class="btn">Search</button>
                        <button id="product-search-clear-btn" class="btn">Clear</button>
                    </div>
                    <div class="dashboard-tabs">
                        <button class="tab-link active" data-tab="pending-tab">Pending <span class="tab-count" id="pending-count">0</span></button>
                        <button class="tab-link" data-tab="approved-tab">Approved <span class="tab-count" id="approved-count">0</span></button>
                        <button class="tab-link" data-tab="rejected-tab">Rejected <span class="tab-count" id="rejected-count">0</span></button>
                    </div>

                    <div id="pending-tab" class="tab-content active">
                        <table class="product-table">
                            <thead>
                                <tr>
                                    <th>Product ID</th>
                                    <th>PO Number</th>
                                    <th>Product Name</th>
                                    <th>Order Date</th>
                                    <th>Delivered Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="pending-list"></tbody>
                        </table>
                    </div>
                    <div id="approved-tab" class="tab-content">
                        <table class="product-table">
                            <thead>
                                <tr>
                                    <th>Product ID</th>
                                    <th>PO Number</th>
                                    <th>Product Name</th>
                                    <th>Order Date</th>
                                    <th>Delivered Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="approved-list"></tbody>
                        </table>
                    </div>
                    <div id="rejected-tab" class="tab-content">
                        <table class="product-table">
                            <thead>
                                <tr>
                                    <th>Product ID</th>
                                    <th>PO Number</th>
                                    <th>Product Name</th>
                                    <th>Order Date</th>
                                    <th>Delivered Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="rejected-list"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Analytics View -->
                <div id="analytics-view" class="hidden">
                    <button id="back-to-dashboard-from-analytics" class="btn">&larr; Back to Dashboard</button>
                    <h2>Clearance Analytics</h2>
                    <div class="analytics-grid">
                        <div class="details-card">
                            <h3>Summary</h3>
                            <p><strong>Total Approved:</strong> <span id="total-approved">0</span></p>
                            <p><strong>Total Rejected:</strong> <span id="total-rejected">0</span></p>
                            <p><strong>Average Clearance Time:</strong> <span id="avg-clearance-time">N/A</span></p>
                        </div>
                        <div class="details-card">
                            <h3>Clearance Status Overview</h3>
                            <canvas id="status-chart"></canvas>
                        </div>
        <div class="details-card">
            <h3>Monthly Clearance Trends</h3>
            <canvas id="monthly-trends-chart"></canvas>
        </div>
                    </div>
                </div>

                <!-- Details View -->
                <div id="details-view" class="hidden">
                    <div id="main-details-col">
                        <button id="back-to-dashboard" class="btn" style="width: fit-content;">&larr; Back to Dashboard</button>
                        
                        <div class="details-main-header">
                            <h3 id="details-product-name">Product Name</h3>
                            <div id="details-product-status"></div>
                        </div>

                        <div class="details-card">
                            <h3>Product Information</h3>
                            <div id="product-info"></div>
                        </div>

                        <!-- Tabbed interface for Quality role -->
                        <div class="details-tabs-container quality-only">
                            <div class="details-tabs">
                                <button class="details-tab-link active" data-tab="inspection-tab">1. Inspection Checklist</button>
                                <button class="details-tab-link" data-tab="analysis-tab">2. AI Analysis</button>
                                <button class="details-tab-link" data-tab="approval-tab">3. Approval</button>
                            </div>

                            <div id="inspection-tab" class="details-tab-content active">
                                <div class="details-card">
                                    <h3>Digital Checklist</h3>
                                    <button id="generate-checklist-btn" class="btn" style="margin-bottom: 15px; background-color: var(--accent-color); color: var(--secondary-color);">✨ Generate AI Checklist</button>
                                    <div id="checklist"></div>
                                </div>
                            </div>
                            <div id="analysis-tab" class="details-tab-content">
                                <div class="analysis-grid">
                                    <div class="details-card">
                                        <h3>
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                            AI Document Comparison
                                        </h3>
                                        <p>Compare the supplier's Quality Certificate against the Technical Bid to find deviations.</p>
                                        <button id="ai-compare-docs-btn" class="btn btn-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                                            Compare Documents
                                        </button>
                                        <div id="ai-comparison-results-container" class="hidden" style="margin-top: 15px;">
                                            <h4>Analysis Results:</h4>
                                            <div id="ai-comparison-results" style="background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 10px; min-height: 100px; white-space: pre-wrap; font-family: monospace;"></div>
                                        </div>
                                    </div>
                                    <div class="details-card">
                                        <h3>
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                                            Image Anomaly Detection
                                        </h3>
                                        <div id="image-upload">
                                            <label for="image-file-input" class="image-upload-box">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                                <p>Click to Upload Image</p>
                                                <span>Or drag and drop here</span>
                                            </label>
                                            <input type="file" id="image-file-input" accept="image/*">
                                            <img id="image-preview" src="" alt="Image Preview">
                                            <div id="ai-image-analysis-container" class="hidden" style="margin-top: 15px;">
                                                <button id="ai-analyze-image-btn" class="btn btn-icon" style="width:100%; background-color: var(--accent-color); color: var(--secondary-color);">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
                                                    Analyze Image for Anomalies
                                                </button>
                                                <div id="ai-image-analysis-results-container" class="hidden" style="margin-top: 15px;">
                                                    <h4>Image Analysis Report:</h4>
                                                    <div id="ai-image-analysis-results" style="background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 10px; min-height: 80px; white-space: pre-wrap; font-family: monospace;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="approval-tab" class="details-tab-content">
                                <div class="details-card">
                                    <h3>Approval Workflow</h3>
                                    <div id="approval-workflow">
                                        <label for="comments">Comments:</label>
                                        <textarea id="comments" placeholder="Add comments for approval or rejection..."></textarea>
                                        <button id="generate-comments-btn" class="btn">✨ Generate AI Comments</button>
                                        <div id="approval-buttons">
                                            <button id="approve-btn" class="btn btn-success">Approve</button>
                                            <button id="reject-btn" class="btn btn-danger">Reject</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="sidebar-col">
                        <div class="details-card">
                            <h3>Documents</h3>
                            <div id="document-list"></div>
                            <div class="document-upload-area technical-only commercial-only">
                                <h4>Upload New Version</h4>
                                <div class="form-group">
                                    <label for="doc-type-select">Document Type</label>
                                    <select id="doc-type-select">
                                        <option value="sop">SOP</option>
                                        <option value="techBid">Technical Bid</option>
                                        <!-- Can add more doc types here -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="doc-file-input">Select File</label>
                                    <input type="file" id="doc-file-input">
                                </div>
                                <button id="upload-doc-btn" class="btn">Upload</button>
                            </div>
                        </div>
                        <div class="details-card">
                            <h3>Audit Trail</h3>
                            <ul id="audit-trail-list"></ul>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div id="profile-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Edit Profile</h2>
            <form id="profile-form">
                <div class="form-group">
                    <label for="profile-name">Full Name</label>
                    <input type="text" id="profile-name" required>
                </div>
                <hr style="margin: 20px 0;">
                <h4>Change Password</h4>
                <div class="form-group">
                    <label for="profile-new-password">New Password</label>
                    <input type="password" id="profile-new-password" placeholder="Leave blank to keep current password">
                </div>
                <div class="form-group">
                    <label for="profile-confirm-password">Confirm New Password</label>
                    <input type="password" id="profile-confirm-password">
                </div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>
    </div>

    <script src="dqc_ai_agent.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA (Simulated Backend/Database) ---
            const users = {
                'quality_user': { role: 'Quality', name: 'Alex Ray' },
                'tech_user': { role: 'Technical', name: 'Ben Carter' },
                'comm_user': { role: 'Commercial', name: 'Chloe Davis' }
            };

            // Data aligned with supplier_collab_app.js for integration
            const products = [
                { id: 'ITEM-001', poNumber: 'PO-12345', name: 'Industrial Grade Sensor', type: 'Electrical', status: 'Pending', assignedTo: 'quality_user', orderDate: '2024-03-10T00:00:00.000Z', deliveredDate: '2024-03-19T00:00:00.000Z', clearedDate: null },
                { id: 'ITEM-002', poNumber: 'PO-12345', name: 'Mounting Bracket Kit', type: 'Mechanical', status: 'Pending', assignedTo: 'quality_user', orderDate: '2024-03-10T00:00:00.000Z', deliveredDate: '2024-03-19T00:00:00.000Z', clearedDate: null },
                { id: 'ITEM-003', poNumber: 'PO-67890', name: 'Servo Motor', type: 'Mechanical', status: 'Rejected', assignedTo: 'quality_user', orderDate: '2024-03-12T00:00:00.000Z', deliveredDate: '2024-03-27T00:00:00.000Z', clearedDate: '2024-03-28T14:00:00.000Z', comments: 'Failed dimensional check and material certificate is missing.' },
                { id: 'ITEM-004', poNumber: 'PO-67890', name: 'Control Board', type: 'Electrical', status: 'Rejected', assignedTo: 'quality_user', orderDate: '2024-03-12T00:00:00.000Z', deliveredDate: '2024-03-27T00:00:00.000Z', clearedDate: '2024-03-28T15:00:00.000Z', comments: 'Component ratings do not match the technical bid.' },
                { id: 'ITEM-005', poNumber: 'PO-ABCDE', name: 'Power Supply Unit', type: 'Electrical', status: 'Pending', assignedTo: 'quality_user', orderDate: '2024-03-15T00:00:00.000Z', deliveredDate: '2024-04-01T00:00:00.000Z', clearedDate: null },
                { id: 'ITEM-006', poNumber: 'PO-XYZ-01', name: 'High-Torque Stepper Motor', type: 'Mechanical', status: 'Pending', assignedTo: 'quality_user', orderDate: '2024-04-02T00:00:00.000Z', deliveredDate: null, clearedDate: null },
                { id: 'ITEM-007', poNumber: 'PO-XYZ-02', name: 'FPGA Development Board', type: 'Electrical', status: 'Pending', assignedTo: 'quality_user', orderDate: '2024-04-05T00:00:00.000Z', deliveredDate: null, clearedDate: null },
                { id: 'ITEM-008', poNumber: 'PO-LMN-03', name: 'Robotic Arm Assembly', type: 'Mechanical', status: 'Approved', assignedTo: 'quality_user', orderDate: '2024-02-20T00:00:00.000Z', deliveredDate: '2024-03-14T00:00:00.000Z', clearedDate: '2024-03-15T09:00:00.000Z' },
                { id: 'ITEM-009', poNumber: 'PO-LMN-04', name: 'Laser Diode Module', type: 'Electrical', status: 'Pending', assignedTo: 'quality_user', orderDate: '2024-04-10T00:00:00.000Z', deliveredDate: '2024-04-26T00:00:00.000Z', clearedDate: null },
                { id: 'ITEM-010', poNumber: 'PO-PQR-05', name: 'Rackmount Server Chassis', type: 'Mechanical', status: 'Approved', assignedTo: 'quality_user', orderDate: '2024-01-15T00:00:00.000Z', deliveredDate: '2024-01-30T00:00:00.000Z', clearedDate: '2024-02-01T16:00:00.000Z' }
            ];

            // New data structure for document versions
            let documentHistory = {
                'ITEM-001': {
                    sop: [{ name: 'SOP_v1.pdf', user: 'comm_user', timestamp: '2024-03-15T10:00:00Z' }],
                    techBid: [{ name: 'TechBid_RevA.docx', user: 'tech_user', timestamp: '2024-03-16T14:30:00Z' }],
                    qualityCertificate: [{ name: 'Cert_of_Compliance.pdf', user: 'supplier@test.com', timestamp: '2024-03-19T11:00:00Z' }]
                },
                'ITEM-003': {
                    sop: [{ name: 'SOP_v1.pdf', user: 'comm_user', timestamp: '2024-03-25T11:00:00Z' }],
                    techBid: [{ name: 'TechBid_RevA.docx', user: 'tech_user', timestamp: '2024-03-26T12:30:00Z' }]
                }
            };

            // Helper to ensure a product has a document history entry
            function ensureDocumentHistory(productId) {
                if (!documentHistory[productId]) {
                    documentHistory[productId] = { sop: [], techBid: [], qualityCertificate: [] };
                }
            }

            let auditTrail = [
                { productId: 'PROD-003', user: 'quality_user', action: 'Approved with minor comments.', timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString() },
                { productId: 'PROD-004', user: 'quality_user', action: 'Rejected: Incorrect software version delivered.', timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString() }
            ];

            let currentUser = null;
            let currentProduct = null;
            let statusChart = null;
            let trendsChart = null;
            let notificationTimeout; // To manage the timeout

            // --- Integration Function ---
            function updateLocalStorageStatuses() {
                const statuses = products.reduce((acc, product) => {
                    acc[product.id] = {
                        status: product.status,
                        comments: product.comments || '' // Also store comments for integration
                    };
                    return acc;
                }, {});
                localStorage.setItem('dqcProductStatuses', JSON.stringify(statuses));
            }

            function showActionConfirmation(message, type = 'info') {
                // Clear any existing timeout to prevent the bar from hiding prematurely
                clearTimeout(notificationTimeout);
                notificationTimeout = null;

                notificationBar.textContent = message;
                notificationBar.className = ''; // Reset classes
                
                if (type === 'success') {
                    notificationBar.classList.add('notification-success');
                } else if (type === 'danger') {
                    notificationBar.classList.add('notification-danger');
                }

                notificationBar.style.display = 'block';
                notificationBar.style.opacity = 1;

                // Set a timeout to hide the bar
                notificationTimeout = setTimeout(() => {
                    notificationBar.style.opacity = 0;
                    setTimeout(() => {
                        notificationBar.style.display = 'none';
                        notificationTimeout = null; // Clear the timeout ID
                        checkNotifications(); // Re-check for persistent notifications
                    }, 500); // This should match the CSS transition duration
                }, 4000); // Show for 4 seconds
            }

            // --- DOM Elements ---
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app-screen');
            const loginForm = document.getElementById('dqc-login-form');
            const usernameInput = document.getElementById('username');
            const userDisplayName = document.getElementById('user-display-name');
            const userRoleDisplay = document.getElementById('user-role');
            const logoutBtn = document.getElementById('logout-btn');
            const notificationBar = document.getElementById('notification-bar');
            const dashboardView = document.getElementById('dashboard-view');
            const detailsView = document.getElementById('details-view');
            const analyticsView = document.getElementById('analytics-view');
            const viewAnalyticsBtn = document.getElementById('view-analytics-btn');
            const backToDashboardFromAnalyticsBtn = document.getElementById('back-to-dashboard-from-analytics');
            const productSearchInput = document.getElementById('product-search-input');
            const productSearchBtn = document.getElementById('product-search-btn');
            const productSearchClearBtn = document.getElementById('product-search-clear-btn');
            const backToDashboardBtn = document.getElementById('back-to-dashboard');

            const profileBtn = document.getElementById('profile-btn');
            const profileModal = document.getElementById('profile-modal');
            const profileForm = document.getElementById('profile-form');
            const profileNameInput = document.getElementById('profile-name');
            const newPasswordInput = document.getElementById('profile-new-password');
            const confirmPasswordInput = document.getElementById('profile-confirm-password');
            const closeModalBtn = profileModal.querySelector('.close-button');
            // --- Core Functions ---

            function handleLogin(e) {
                e.preventDefault();
                const username = usernameInput.value;
                if (users[username]) {
                    currentUser = { username, ...users[username] };
                    loginScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                    setupUIForRole();
                    renderDashboard();
                    checkNotifications();
                    updateLocalStorageStatuses(); // Integration: Set initial statuses

                    // Notify parent dashboard that login was successful
                    window.parent.postMessage({ type: 'userLoggedIn' }, '*');
                } else {
                    document.getElementById('dqc-login-error').classList.remove('hidden');
                }
            }

            function handleLogout() {
                currentUser = null;
                appScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                usernameInput.value = '';
                // Hide all role-specific elements
                document.body.classList.remove('role-Quality', 'role-Technical', 'role-Commercial');

                // Notify parent dashboard of logout
                window.parent.postMessage({ type: 'userLoggedOut' }, '*');
            }

            function setupUIForRole() {
                userDisplayName.textContent = currentUser.name;
                userRoleDisplay.textContent = currentUser.role;
                
                // Add a class to the body to control visibility with CSS
                document.body.className = `role-${currentUser.role}`;
                const style = document.createElement('style');
                style.innerHTML = `
                    .role-Quality .quality-only { display: block; }
                    .role-Technical .technical-only { display: block; }
                    .role-Commercial .commercial-only { display: block; }
                `;
                document.head.appendChild(style);
            }

            function checkNotifications() {
                // If a temporary confirmation is being shown, don't show the pending items notification.
                if (notificationTimeout) return;

                // A notification is shown for all 'Pending' products assigned to the current Quality user.
                if (!currentUser || currentUser.role !== 'Quality') return;

                const pendingProducts = products.filter(p => p.assignedTo === currentUser.username && p.status === 'Pending');
                if (pendingProducts.length > 0) {
                    notificationBar.textContent = `You have ${pendingProducts.length} product(s) awaiting quality clearance.`;
                    notificationBar.className = ''; // Reset to default style
                    notificationBar.style.display = 'block';
                    notificationBar.style.opacity = 1;
                } else {
                    notificationBar.style.display = 'none';
                }
            }

            function renderDashboard(searchTerm = '') {
                const pendingList = document.getElementById('pending-list');
                const approvedList = document.getElementById('approved-list');
                const rejectedList = document.getElementById('rejected-list');

                pendingList.innerHTML = '';
                approvedList.innerHTML = '';
                rejectedList.innerHTML = '';

                // Filter products if a search term is provided
                const lowerCaseSearchTerm = searchTerm.trim().toLowerCase();
                const userProducts = lowerCaseSearchTerm
                    ? products.filter(p => 
                        p.id.toLowerCase().includes(lowerCaseSearchTerm) ||
                        p.name.toLowerCase().includes(lowerCaseSearchTerm) ||
                        (p.poNumber && p.poNumber.toLowerCase().includes(lowerCaseSearchTerm))
                      )
                    : products;

                let pendingCount = 0;
                let approvedCount = 0;
                let rejectedCount = 0;

                userProducts.forEach(product => {
                    const row = document.createElement('tr');
                    row.dataset.productId = product.id;
                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td>${product.poNumber || 'N/A'}</td>
                        <td>${product.name}</td>
                        <td>${product.orderDate ? new Date(product.orderDate).toLocaleDateString() : 'N/A'}</td>
                        <td>${product.deliveredDate ? new Date(product.deliveredDate).toLocaleDateString() : 'N/A'}</td>
                        <td><span class="status-badge status-${product.status}">${product.status}</span></td>
                    `;
                    row.addEventListener('click', () => showDetails(product.id));

                    switch (product.status) {
                        case 'Pending':
                        case 'Delivered':
                            pendingList.appendChild(row);
                            pendingCount++;
                            break;
                        case 'Approved':
                            approvedList.appendChild(row);
                            approvedCount++;
                            break;
                        case 'Rejected':
                            rejectedList.appendChild(row);
                            rejectedCount++;
                            break;
                    }
                });

                // Update tab counts
                document.getElementById('pending-count').textContent = pendingCount;
                document.getElementById('approved-count').textContent = approvedCount;
                document.getElementById('rejected-count').textContent = rejectedCount;

                showView('dashboard');
            }

            function showDetails(productId) {
                currentProduct = products.find(p => p.id === productId);
                if (!currentProduct) return;

                // Populate details
                document.getElementById('details-product-name').textContent = `${currentProduct.name} (${currentProduct.id})`;
                document.getElementById('details-product-status').innerHTML = `<span class="status-badge status-${currentProduct.status}">${currentProduct.status}</span>`;

                document.getElementById('product-info').innerHTML = `
                    <p><strong>Type:</strong> ${currentProduct.type}</p>
                    <p><strong>PO Number:</strong> ${currentProduct.poNumber || 'N/A'}</p>
                    <p><strong>Order Date:</strong> ${currentProduct.orderDate ? new Date(currentProduct.orderDate).toLocaleDateString() : 'N/A'}</p>
                    <p><strong>Delivered Date:</strong> ${currentProduct.deliveredDate ? new Date(currentProduct.deliveredDate).toLocaleDateString() : 'N/A'}</p>
                    <p><strong>Cleared Date:</strong> ${currentProduct.clearedDate ? new Date(currentProduct.clearedDate).toLocaleDateString() : 'N/A'}</p>
                `;

                // Render Documents with Version History
                renderDocumentList(productId);

                // Checklist
                const checklistContainer = document.getElementById('checklist');
                // Clear previous checklist and show a placeholder
                checklistContainer.innerHTML = `<p>Click "Generate AI Checklist" to create an inspection list based on project documents.</p>`;

                // Reset tabs to default state
                document.querySelectorAll('.details-tab-link').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.details-tab-content').forEach(c => c.classList.remove('active'));
                const defaultTabLink = document.querySelector('.details-tab-link[data-tab="inspection-tab"]');
                const defaultTabContent = document.getElementById('inspection-tab');
                if(defaultTabLink && defaultTabContent) {
                    defaultTabLink.classList.add('active');
                    defaultTabContent.classList.add('active');
                }

                // Reset forms
                document.getElementById('image-file-input').value = '';
                document.getElementById('image-preview').style.display = 'none';
                document.getElementById('ai-image-analysis-container').classList.add('hidden');
                document.getElementById('comments').value = '';

                renderAuditTrail(productId);
                showView('details');
            }

            function renderDocumentList(productId) {
                ensureDocumentHistory(productId);
                const history = documentHistory[productId];
                const docListContainer = document.getElementById('document-list');

                let html = '<h5>Latest Documents</h5>';

                const renderDoc = (docType, docTitle) => {
                    const docVersions = history[docType] || [];
                    if (docVersions.length > 0) {
                        const latest = docVersions[docVersions.length - 1];
                        const user = users[latest.user] || { name: 'Supplier' }; // Handle non-system users like suppliers
                        html += `<p>
                            <strong>${docTitle}:</strong> 
                            <a href="#" onclick="event.preventDefault(); alert('Simulating download of ${latest.name}. In a real app, this would open the document.')" target="_blank">${latest.name}</a> 
                            (v${docVersions.length}, uploaded by ${user.name} on ${new Date(latest.timestamp).toLocaleDateString()})
                        </p>`;
                    } else {
                        html += `<p><strong>${docTitle}:</strong> No document uploaded.</p>`;
                    }
                };

                renderDoc('qualityCertificate', 'Quality Certificate');
                renderDoc('sop', 'SOP');
                renderDoc('techBid', 'Technical Bid');
                docListContainer.innerHTML = html;
            }
            function renderAuditTrail(productId) {
                const trailList = document.getElementById('audit-trail-list');
                trailList.innerHTML = '';
                const productTrail = auditTrail.filter(log => log.productId === productId).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                if (productTrail.length === 0) {
                    trailList.innerHTML = '<li>No actions logged yet.</li>';
                    return;
                }
                productTrail.forEach(log => {
                    const item = document.createElement('li');
                    const user = users[log.user] || { name: 'System' };
                    item.innerHTML = `
                        <span class="audit-timestamp">${new Date(log.timestamp).toLocaleString()}:</span>
                        <strong>${user.name}</strong> - ${log.action}
                    `;
                    trailList.appendChild(item);
                });
            }

            function logAction(productId, action) {
                auditTrail.push({
                    productId,
                    user: currentUser.username,
                    action,
                    timestamp: new Date().toISOString()
                });
            }

            function createChecklistItem(text) {
                const li = document.createElement('li');
                li.innerHTML = `
                    <label class="sr-only">Check item</label>
                    <input type="checkbox">
                    <span class="checklist-text" contenteditable="true">${text}</span>
                    <button class="delete-item-btn" title="Delete item">&times;</button>
                `;
                return li;
            }

            function handleAddItem() {
                const input = document.getElementById('new-checklist-item-input');
                const text = input.value.trim();
                if (text) {
                    const list = document.querySelector('#checklist ul');
                    const newItem = createChecklistItem(text);
                    list.appendChild(newItem);
                    input.value = '';
                    input.focus();
                    logAction(currentProduct.id, `Manually added checklist item: "${text}"`);
                    renderAuditTrail(currentProduct.id);
                }
            }

            function renderEditableChecklist(items) {
                const checklistContainer = document.getElementById('checklist');
                const list = document.createElement('ul');

                items.forEach(itemText => {
                    const li = createChecklistItem(itemText.trim());
                    list.appendChild(li);
                });

                checklistContainer.innerHTML = ''; // Clear previous content
                checklistContainer.appendChild(list);

                // Add the form for new items
                const addFormHtml = `
                    <div id="add-checklist-item-form">
                        <input type="text" id="new-checklist-item-input" placeholder="Add a new checklist item..." class="form-group" style="flex-grow:1; margin:0;">
                        <button id="add-checklist-item-btn" class="btn" style="flex-shrink:0;">Add</button>
                    </div>
                `;
                checklistContainer.insertAdjacentHTML('beforeend', addFormHtml);

                document.getElementById('add-checklist-item-btn').addEventListener('click', handleAddItem);
                document.getElementById('new-checklist-item-input').addEventListener('keyup', (e) => { if (e.key === 'Enter') handleAddItem(); });
            }

            async function handleGenerateAIChecklist() {
                if (!currentProduct) return;

                const generateBtn = document.getElementById('generate-checklist-btn');
                const checklistContainer = document.getElementById('checklist');

                // 1. Show loading state
                generateBtn.disabled = true;
                generateBtn.textContent = 'Generating...';
                checklistContainer.innerHTML = '<p>AI is analyzing documents and creating a checklist...</p>';

                try {
                    // 2. Ensure document history exists
                    ensureDocumentHistory(currentProduct.id);
                    const history = documentHistory[currentProduct.id];

                    // 3. Call the AI agent module
                    const checklistString = await AIAgent.generateChecklist(currentProduct, history);

                    // 4. Parse the response and render the checklist
                    const checklistItems = checklistString.split('\n').filter(item => item.trim() !== '');
                    if (checklistItems.length > 0) {
                        renderEditableChecklist(checklistItems);
                        logAction(currentProduct.id, 'Generated checklist using AI.');
                        renderAuditTrail(currentProduct.id);
                    } else {
                        throw new Error("AI did not return any checklist items.");
                    }

                } catch (error) {
                    console.error("AI Checklist Generation Error:", error);
                    checklistContainer.innerHTML = `<p style="color: var(--danger-color);">An error occurred: ${error.message}</p>`;
                } finally {
                    // 5. Reset button state
                    generateBtn.disabled = false;
                    generateBtn.textContent = '✨ Generate AI Checklist';
                }
            }

            async function handleImageAnomalyDetection() {
                if (!currentProduct) return;

                const analyzeBtn = document.getElementById('ai-analyze-image-btn');
                const resultsContainer = document.getElementById('ai-image-analysis-results-container');
                const resultsDiv = document.getElementById('ai-image-analysis-results');
                const imageInput = document.getElementById('image-file-input');

                if (!imageInput.files || imageInput.files.length === 0) {
                    alert("Please upload an image first.");
                    return;
                }
                const imageName = imageInput.files[0].name;

                // 1. Show loading state
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = 'Analyzing...';
                resultsContainer.classList.remove('hidden');
                resultsDiv.textContent = 'AI is performing visual inspection...';

                try {
                    // 2. Call the AI agent module
                    const analysisResult = await AIAgent.analyzeImageForAnomalies(imageName, currentProduct);

                    // 3. Display results
                    resultsDiv.textContent = analysisResult;
                    logAction(currentProduct.id, `Performed AI anomaly detection on image: ${imageName}.`);
                    renderAuditTrail(currentProduct.id);
                } catch (error) {
                    console.error("AI Image Analysis Error:", error);
                    resultsDiv.textContent = `An error occurred: ${error.message}`;
                } finally {
                    // 4. Reset button state
                    analyzeBtn.disabled = false;
                    analyzeBtn.textContent = '🔬 Analyze Image for Anomalies';
                }
            }

            async function handleAIDocumentComparison() {
                if (!currentProduct) return;

                const compareBtn = document.getElementById('ai-compare-docs-btn');
                const resultsContainer = document.getElementById('ai-comparison-results-container');
                const resultsDiv = document.getElementById('ai-comparison-results');

                // 1. Show loading state
                compareBtn.disabled = true;
                compareBtn.textContent = 'Analyzing...';
                resultsDiv.textContent = 'AI is reading documents and comparing specifications...';
                resultsContainer.classList.remove('hidden');

                try {
                    // 2. Ensure document history exists
                    ensureDocumentHistory(currentProduct.id);
                    const history = documentHistory[currentProduct.id];

                    // 3. Call the AI agent module, which handles prompt creation and the API call
                    const analysisResult = await AIAgent.compareDocuments(currentProduct, history);

                    // 5. Display results
                    resultsDiv.textContent = analysisResult;
                    logAction(currentProduct.id, 'Performed AI document comparison.');
                    renderAuditTrail(currentProduct.id);
                } catch (error) {
                    console.error("AI Comparison Error:", error);
                    resultsDiv.textContent = `An error occurred: ${error.message}`;
                } finally {
                    // 6. Reset button state
                    compareBtn.disabled = false;
                    // Restore the button's icon and text
                    compareBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                        Compare Documents
                    `;
                }
            }

            async function handleGenerateAIComments() {
                const commentsTextarea = document.getElementById('comments');
                const generateBtn = document.getElementById('generate-comments-btn');

                // 1. Find which checklist items are NOT checked
                const failedItems = [];
                document.querySelectorAll('#checklist input[type="checkbox"]:not(:checked)').forEach(checkbox => {
                    failedItems.push(checkbox.parentElement.textContent.trim());
                });

                if (failedItems.length === 0) {
                    alert("To generate rejection comments, please uncheck the checklist items that failed inspection.");
                    return;
                }

                // 2. Disable button and show loading state
                generateBtn.disabled = true;
                generateBtn.textContent = 'Generating...';
                commentsTextarea.value = 'AI is thinking...';

                try {
                    // 3. Call the AI agent module
                    const generatedComment = await AIAgent.generateRejectionComments(failedItems);
                    commentsTextarea.value = generatedComment;
                } catch (error) {
                    console.error("AI Generation Error:", error);
                    commentsTextarea.value = `An error occurred while generating comments: ${error.message}`;
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.textContent = '✨ Generate AI Comments';
                }
            }

            function updateStatus(newStatus) {
                if (!currentProduct) return;
                const comments = document.getElementById('comments').value;
                if (!comments) {
                    alert('Please provide comments before approving or rejecting.');
                    return;
                }

                // Prevent approval if the checklist is incomplete
                if (newStatus === 'Approved') {
                    const checklistCheckboxes = document.querySelectorAll('#checklist input[type="checkbox"]');
                    const allChecked = Array.from(checklistCheckboxes).every(cb => cb.checked);
                    if (!allChecked) {
                        alert('Please complete all items in the checklist before approving.');
                        return; // Stop the approval process
                    }
                }

                currentProduct.status = newStatus;
                currentProduct.clearedDate = new Date().toISOString();
                currentProduct.comments = comments; // Store comments on the product object
                const action = `${newStatus} with comments: "${comments}"`;
                logAction(currentProduct.id, action);
                
                // --- Inter-App Communication: Send status update back to parent ---
                window.parent.postMessage({
                    type: 'dqcStatusUpdate',
                    payload: {
                        productId: currentProduct.id,
                        status: newStatus,
                        comments: comments
                    }
                }, '*');

                
                const confirmationType = newStatus === 'Approved' ? 'success' : 'danger';
                showActionConfirmation(`Product ${currentProduct.id} has been ${newStatus}.`, confirmationType);

                renderDashboard();
                checkNotifications();
                updateLocalStorageStatuses(); // Integration: Broadcast status change
            }

            function handleDocumentUpload() {
                const docType = document.getElementById('doc-type-select').value;
                const fileInput = document.getElementById('doc-file-input');
                const file = fileInput.files[0];

                if (!file) {
                    alert('Please select a file to upload.');
                    return;
                }

                ensureDocumentHistory(currentProduct.id);
                const newVersion = { name: file.name, user: currentUser.username, timestamp: new Date().toISOString() };
                documentHistory[currentProduct.id][docType].push(newVersion);

                const docTitle = docType === 'sop' ? 'SOP' : 'Technical Bid';
                logAction(currentProduct.id, `Uploaded new version of ${docTitle}: ${file.name}`);

                renderDocumentList(currentProduct.id);
                renderAuditTrail(currentProduct.id);
                fileInput.value = ''; // Reset file input
                alert('Document uploaded successfully.');
            }

            function renderAnalytics() {
                // Calculate metrics
                const approvedProducts = products.filter(p => p.status === 'Approved');
                const rejectedProducts = products.filter(p => p.status === 'Rejected');
                const totalApproved = approvedProducts.length;
                const totalRejected = rejectedProducts.length;

                // Calculate average clearance time
                let totalClearanceTime = 0;
                let clearedCount = 0;
                products.forEach(p => {
                    if (p.clearedDate && p.deliveredDate) {
                        const delivered = new Date(p.deliveredDate);
                        const cleared = new Date(p.clearedDate);
                        const diffTime = Math.abs(cleared - delivered);
                        totalClearanceTime += diffTime;
                        clearedCount++;
                    }
                });

                let avgClearanceTimeText = 'N/A';
                if (clearedCount > 0) {
                    const avgMilliseconds = totalClearanceTime / clearedCount;
                    const avgHours = avgMilliseconds / (1000 * 60 * 60);
                    if (avgHours < 24) {
                        avgClearanceTimeText = `${avgHours.toFixed(1)} hours`;
                    } else {
                        const avgDays = avgHours / 24;
                        avgClearanceTimeText = `${avgDays.toFixed(1)} days`;
                    }
                }

                // Update summary card
                document.getElementById('total-approved').textContent = totalApproved;
                document.getElementById('total-rejected').textContent = totalRejected;
                document.getElementById('avg-clearance-time').textContent = avgClearanceTimeText;

                // Render chart
                const ctx = document.getElementById('status-chart').getContext('2d');
                if (statusChart) {
                    statusChart.destroy();
                }
                statusChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Approved', 'Rejected'],
                        datasets: [{
                            label: 'Request Status',
                            data: [totalApproved, totalRejected],
                            backgroundColor: ['#28a745', '#dc3545'],
                            borderColor: ['#ffffff'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Approved vs. Rejected Requests' }
                        }
                    }
                });

                // --- Render Monthly Trends Line Chart ---
                const trendsCtx = document.getElementById('monthly-trends-chart').getContext('2d');
                if (trendsChart) {
                    trendsChart.destroy();
                }

                // --- Logic for Monthly Trends ---
                const labels = [];
                const approvedCounts = Array(12).fill(0);
                const rejectedCounts = Array(12).fill(0);
                const today = new Date();
                today.setDate(1); // Use the 1st of the month for consistent month calculations

                // 1. Generate labels for the last 12 months
                for (let i = 11; i >= 0; i--) {
                    const date = new Date(today);
                    date.setMonth(today.getMonth() - i);
                    labels.push(date.toLocaleString('default', { month: 'short', year: 'numeric' }));
                }

                // 2. Define the time window for filtering products
                const twelveMonthsAgo = new Date(today);
                twelveMonthsAgo.setMonth(today.getMonth() - 11);
                const endOfToday = new Date();
                endOfToday.setHours(23, 59, 59, 999);

                // 3. Group products by month
                products.forEach(p => {
                    if (p.clearedDate) {
                        const clearedDate = new Date(p.clearedDate);
                        if (clearedDate >= twelveMonthsAgo && clearedDate <= endOfToday) {
                            const label = clearedDate.toLocaleString('default', { month: 'short', year: 'numeric' });
                            const index = labels.indexOf(label);
                            if (index > -1) {
                                if (p.status === 'Approved') {
                                    approvedCounts[index]++;
                                } else if (p.status === 'Rejected') {
                                    rejectedCounts[index]++;
                                }
                            }
                        }
                    }
                });
                // 4. Render the chart
                trendsChart = new Chart(trendsCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Approved',
                            data: approvedCounts,
                            borderColor: 'var(--success-color)',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            fill: true,
                            tension: 0.1
                        }, {
                            label: 'Rejected',
                            data: rejectedCounts,
                            borderColor: 'var(--danger-color)',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' }, title: { display: true, text: 'Clearances Over Last 12 Months' } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });

                showView('analytics');
            }

            function showView(viewName) {
                dashboardView.classList.add('hidden');
                detailsView.classList.add('hidden');
                analyticsView.classList.add('hidden');
                if (viewName === 'dashboard') {
                    dashboardView.classList.remove('hidden');
                } else if (viewName === 'details') {
                    detailsView.classList.remove('hidden');
                } else if (viewName === 'analytics') {
                    analyticsView.classList.remove('hidden');
                }
            }

            // --- Profile Modal Functions ---
            function openProfileModal() {
                if (currentUser) {
                    profileNameInput.value = currentUser.name;
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                    profileModal.classList.remove('hidden');
                }
            }

            function closeProfileModal() {
                profileModal.classList.add('hidden');
            }

            function handleProfileUpdate(e) {
                e.preventDefault();
                const newName = profileNameInput.value.trim();
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                let changesMade = false;

                // Update name if it has changed
                if (newName && newName !== currentUser.name) {
                    // Update the local data store
                    currentUser.name = newName;
                    users[currentUser.username].name = newName;
                    // Update the UI
                    userDisplayName.textContent = newName;
                    logAction(currentUser.username, 'Updated profile name.');
                    changesMade = true;
                }

                // Update password if new password is provided
                if (newPassword) {
                    if (newPassword !== confirmPassword) {
                        alert('Passwords do not match. Please try again.');
                        return;
                    }
                    // In a real app, you would hash and save the new password.
                    // For this simulation, we'll just acknowledge the change.
                    logAction(currentUser.username, 'Updated password.');
                    changesMade = true;
                }

                if (changesMade) {
                    showActionConfirmation('Profile updated successfully!', 'success');
                    closeProfileModal();
                } else {
                    closeProfileModal();
                }

                newPasswordInput.value = '';
                confirmPasswordInput.value = '';
            }

            // --- Event Listeners ---
            loginForm.addEventListener('submit', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            backToDashboardBtn.addEventListener('click', () => {
                productSearchInput.value = '';
                renderDashboard();
            });
            viewAnalyticsBtn.addEventListener('click', renderAnalytics);
            backToDashboardFromAnalyticsBtn.addEventListener('click', () => {
                productSearchInput.value = '';
                renderDashboard();
            });

            productSearchBtn.addEventListener('click', () => renderDashboard(productSearchInput.value));
            productSearchClearBtn.addEventListener('click', () => {
                productSearchInput.value = '';
                renderDashboard();
            });
            productSearchInput.addEventListener('keyup', e => {
                if (e.key === 'Enter') {
                    renderDashboard(productSearchInput.value);
                }
            });

            document.querySelectorAll('.tab-link').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;

                    document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    tab.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });

            // Details View Tabs
            const detailsTabsContainer = document.querySelector('.details-tabs-container');
            if (detailsTabsContainer) {
                detailsTabsContainer.addEventListener('click', (e) => {
                    if (e.target.matches('.details-tab-link')) {
                        const tabId = e.target.dataset.tab;
                        // Deactivate all tabs within this container
                        detailsTabsContainer.querySelectorAll('.details-tab-link').forEach(t => t.classList.remove('active'));
                        detailsTabsContainer.querySelectorAll('.details-tab-content').forEach(c => c.classList.remove('active'));
                        
                        // Activate the clicked one
                        e.target.classList.add('active');
                        document.getElementById(tabId).classList.add('active');
                    }
                });
            }

            profileBtn.addEventListener('click', openProfileModal);
            closeModalBtn.addEventListener('click', closeProfileModal);
            profileForm.addEventListener('submit', handleProfileUpdate);
            window.addEventListener('click', (event) => {
                if (event.target == profileModal) { closeProfileModal(); }
            });

            document.getElementById('approve-btn').addEventListener('click', () => updateStatus('Approved'));
            document.getElementById('reject-btn').addEventListener('click', () => updateStatus('Rejected'));
            document.getElementById('generate-comments-btn').addEventListener('click', handleGenerateAIComments);
            document.getElementById('upload-doc-btn').addEventListener('click', handleDocumentUpload);
            document.getElementById('generate-checklist-btn').addEventListener('click', handleGenerateAIChecklist);
            document.getElementById('ai-compare-docs-btn').addEventListener('click', handleAIDocumentComparison);
            document.getElementById('ai-analyze-image-btn').addEventListener('click', handleImageAnomalyDetection);

            // --- Event Delegation for Editable Checklist ---
            const checklistContainer = document.getElementById('checklist');

            // Handle item deletion
            checklistContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-item-btn')) {
                    const itemLi = e.target.closest('li');
                    if (itemLi) {
                        const itemText = itemLi.querySelector('.checklist-text').textContent;
                        itemLi.remove();
                        logAction(currentProduct.id, `Removed checklist item: "${itemText}"`);
                        renderAuditTrail(currentProduct.id);
                    }
                }
            });

            // Handle item editing (log on blur)
            checklistContainer.addEventListener('focusin', (e) => {
                if (e.target.classList.contains('checklist-text')) {
                    e.target.dataset.originalText = e.target.textContent.trim();
                }
            });
            checklistContainer.addEventListener('focusout', (e) => {
                if (e.target.classList.contains('checklist-text')) {
                    const newText = e.target.textContent.trim();
                    const originalText = e.target.dataset.originalText;
                    if (newText !== originalText) {
                        logAction(currentProduct.id, `Edited checklist item from "${originalText}" to "${newText}"`);
                        renderAuditTrail(currentProduct.id);
                    }
                }
            });

            document.getElementById('image-file-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const preview = document.getElementById('image-preview');
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        logAction(currentProduct.id, `Uploaded image: ${file.name}`);
                        renderAuditTrail(currentProduct.id);

                        // Show the AI analysis button and reset its state
                        document.getElementById('ai-image-analysis-container').classList.remove('hidden');
                        document.getElementById('ai-image-analysis-results-container').classList.add('hidden');
                        document.getElementById('ai-image-analysis-results').textContent = 'Click "Analyze Image" to start the analysis.';
                        const analyzeBtn = document.getElementById('ai-analyze-image-btn');
                        analyzeBtn.disabled = false;
                        analyzeBtn.textContent = '🔬 Analyze Image for Anomalies';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // --- Inter-App Communication Receiver ---
            window.addEventListener('message', (event) => {
                // As a security best practice, you might check event.origin here as well.
                const message = event.data;

                if (message && message.type === 'supplierDocUpload') {
                    console.log('DQC App received data from dashboard:', message.payload);
                    handleSupplierDocumentUpload(message.payload);
                }
            });

            function handleSupplierDocumentUpload(data) {
                const { productId, docType, document } = data;

                // 1. Find the product in the local data model
                const product = products.find(p => p.id === productId);
                if (!product) {
                    console.warn(`Received document for unknown product ID: ${productId}`);
                    return;
                }

                // 2. Update the document history data
                ensureDocumentHistory(productId); // This helper function already exists
                if (!documentHistory[productId][docType]) {
                    documentHistory[productId][docType] = [];
                }
                documentHistory[productId][docType].push(document);

                // 3. Log the action in the audit trail for traceability
                const logMessage = `Received new document via Supplier Portal: ${document.name}`;
                logAction(productId, logMessage);

                // 4. Refresh the UI if the user is currently viewing the affected product
                if (currentProduct && currentProduct.id === productId && !detailsView.classList.contains('hidden')) {
                    renderDocumentList(productId);
                    renderAuditTrail(productId);
                }

                // 5. Show a toast notification to the user
                showActionConfirmation(`New document received for product ${productId}.`, 'success');
            }

        });
    </script>
</body>
</html>